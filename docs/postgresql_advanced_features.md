# PostgreSQL高级功能增强文档

## 概述

本文档详细介绍了A股量化分析系统中PostgreSQL数据库的高级功能增强，包括触发器、存储过程、函数和物化视图等。这些功能旨在减轻Python端的计算压力，提高系统性能，并增强数据处理能力。

## 功能列表

### 1. 数据版本管理与审计

- **数据版本历史表**：记录所有数据变更，支持数据追溯和审计
- **审计触发器**：自动记录数据的插入、更新和删除操作
- **版本比较功能**：比较不同版本的数据差异

### 2. 自动更新触发器

- **时间戳更新**：自动更新数据的修改时间
- **数据一致性校验**：确保资产负债表等财务数据的一致性

### 3. 数据计算与汇总

- **财务比率计算**：自动计算资产负债率、净资产收益率等财务指标
- **行业平均指标**：计算行业平均财务指标，便于横向比较
- **物化视图**：预计算并缓存常用查询结果，提高查询性能

### 4. 数据变更通知

- **数据库通知机制**：当数据发生变化时发送通知
- **通知监听器**：Python端可以监听数据库通知，实现实时响应

### 5. 数据库维护

- **统计信息收集**：自动收集数据库统计信息，优化查询性能
- **物化视图刷新**：定期刷新物化视图，保持数据最新

## 使用方法

### 安装数据库增强功能

执行以下命令安装所有数据库增强功能：

```bash
python scripts/apply_db_enhancements.py --apply
```

检查安装状态：

```bash
python scripts/apply_db_enhancements.py --check
```

### 使用增强版PostgreSQL管理器

在Python代码中使用增强版PostgreSQL管理器：

```python
from data.storage.enhanced_postgresql_manager import EnhancedPostgreSQLManager

# 创建增强版PostgreSQL管理器实例
db = EnhancedPostgreSQLManager()

# 计算财务指标
db.calculate_financial_ratios(stock_code="000001", report_date="2023-12-31")

# 获取财务指标
ratios = db.get_financial_ratios("000001")
print(f"财务指标: {ratios}")

# 获取行业平均指标
industry_avg = db.get_industry_average("银行", "2023-12-31")
print(f"行业平均指标: {industry_avg}")

# 监听数据库通知
notifications = db.check_notifications(timeout=5)
for notify in notifications:
    print(f"收到通知: {notify}")

# 刷新物化视图
db.refresh_materialized_view()

# 执行数据库维护
db.perform_database_maintenance()

# 获取数据版本历史
history = db.get_data_version_history(table_name="资产负债表", limit=10)
print(f"数据版本历史: {history}")

# 比较数据版本
diff = db.compare_data_versions(version_id1="uuid-1", version_id2="uuid-2")
print(f"版本差异: {diff}")

# 关闭数据库连接
db.close()
```

### 命令行工具

使用命令行工具执行常用操作：

```bash
# 计算所有股票的财务指标
python scripts/apply_db_enhancements.py --calculate

# 计算特定股票的财务指标
python scripts/apply_db_enhancements.py --calculate --stock 000001

# 计算特定报告期的财务指标
python scripts/apply_db_enhancements.py --calculate --date 2023-12-31

# 刷新物化视图
python scripts/apply_db_enhancements.py --refresh

# 执行数据库维护
python scripts/apply_db_enhancements.py --maintenance
```

## 数据库触发器说明

### 审计触发器

当对以下表进行插入、更新或删除操作时，会自动记录操作信息到`数据版本历史`表：

- 资产负债表
- 利润表
- 现金流量表

### 自动更新时间戳触发器

当对以下表进行更新操作时，会自动更新`更新时间`字段：

- 资产负债表
- 利润表
- 现金流量表

### 数据一致性校验触发器

当对资产负债表进行插入或更新操作时，会自动检查资产总计是否等于负债合计加股东权益合计。

### 自动更新财务指标触发器

当对资产负债表或利润表进行插入、更新或删除操作时，会自动调用`计算并存储财务指标`存储过程，更新相关财务指标。

## 存储过程和函数说明

### 计算财务比率函数

```sql
计算财务比率(股票代码, 报告期)
```

计算指定股票在指定报告期的财务比率，包括资产负债率、流动比率、净资产收益率、毛利率和净利率等。

### 计算行业平均财务指标函数

```sql
计算行业平均财务指标(行业, 报告期)
```

计算指定行业在指定报告期的平均财务指标，便于横向比较。

### 计算并存储财务指标存储过程

```sql
计算并存储财务指标(股票代码, 报告期)
```

计算并存储财务指标到`财务指标`表，可以指定特定股票和报告期，也可以计算所有股票和报告期的指标。

### 刷新财务指标物化视图函数

```sql
刷新财务指标物化视图()
```

刷新`财务指标_物化视图`，更新预计算的财务指标数据。

### 数据库维护存储过程

```sql
数据库维护()
```

执行数据库维护操作，包括收集统计信息和刷新物化视图等。

## 物化视图说明

### 财务指标物化视图

`财务指标_物化视图`预计算并缓存常用的财务指标，包括：

- 资产总计
- 负债合计
- 股东权益合计
- 营业收入
- 净利润
- 经营活动产生的现金流量净额
- 资产负债率
- 净资产收益率
- 净利率

## 数据库通知说明

### 数据更新通知

当对以下表进行插入、更新或删除操作时，会自动发送通知到`数据更新通知`频道：

- 资产负债表
- 利润表

通知内容包括表名、操作类型、操作时间和相关数据。

## 性能优化建议

1. **使用物化视图**：对于频繁查询但不常变化的数据，使用物化视图可以显著提高查询性能。

2. **定期维护**：定期执行`数据库维护`存储过程，保持数据库性能最优。

3. **使用存储过程**：对于复杂的数据处理逻辑，使用存储过程可以减少网络传输和Python处理开销。

4. **监听数据库通知**：使用数据库通知机制可以实现实时响应数据变化，避免轮询。

5. **利用触发器**：使用触发器可以确保数据一致性和完整性，减少应用层的验证逻辑。

## 注意事项

1. 数据库增强功能需要PostgreSQL 12+版本支持。

2. 首次应用增强功能可能需要较长时间，特别是对于大型数据库。

3. 物化视图会占用额外的存储空间，但可以显著提高查询性能。

4. 触发器会增加数据写入的开销，但可以确保数据一致性和完整性。

5. 数据版本历史表会随着时间增长，可能需要定期清理或归档。