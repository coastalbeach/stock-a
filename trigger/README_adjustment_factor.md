# 复权因子更新程序使用说明

## 概述

本程序用于解决股票后复权数据计算的问题，特别是针对AKShare接口提供的复权因子数据存在错误的情况。程序通过比较不复权和后复权数据，计算出正确的复权因子，并更新数据库中的复权因子表，从而确保后复权数据的准确性。

## 核心功能

1. **复权因子计算**：通过比较不复权和后复权数据，计算出准确的复权因子
2. **错误数据检测与修复**：检测并清除使用错误复权系数计算的后复权数据
3. **定期检查**：支持定期检查复权系数是否变更
4. **数据库集成**：与PostgreSQL数据库紧密集成，支持触发器自动更新后复权数据

## 复权价格计算原理

复权价格计算公式为：

```
复权价格 = a * 不复权价格 + b
```

其中，a和b是系数。在本程序中，我们简化为：

```
后复权价格 = 后复权因子 * 不复权价格
```

即b=0，a=后复权因子。

## 使用方法

### 基本用法

```bash
python adjustment_factor_updater.py
```

这将更新所有股票的复权因子。

### 调试模式

```bash
python adjustment_factor_updater.py --limit 10
```

这将只处理前10只股票，用于测试和调试。

### 处理单只股票

```bash
python adjustment_factor_updater.py --stock 600000
```

这将只处理指定的股票（例如600000）。

### 自定义检查天数

```bash
python adjustment_factor_updater.py --check-days 60
```

这将检查最近60天的数据（默认为30天）。

## 工作流程

1. 程序首先检查并创建复权因子表（如果不存在）
2. 获取股票列表
3. 对每只股票：
   - 获取最近的除权除息日期（如果有）
   - 获取不复权和后复权数据
   - 计算复权因子
   - 删除可能错误的后复权数据
   - 保存新的复权因子
   - 触发器会自动更新后复权数据

## 与触发器的集成

本程序设计为与PostgreSQL触发器配合使用：

1. 程序计算并更新复权因子表
2. 触发器监听复权因子表的变化
3. 当复权因子更新时，触发器自动重新计算并更新后复权数据

这种设计将数据处理逻辑从Python程序转移到数据库端，提高了效率和一致性。

## 注意事项

1. **初始化后的日常维护**：初始化数据库后，建议每月运行一次程序检查复权系数是否变更
2. **错误数据处理**：程序会自动清除使用旧系数的错误复权数据
3. **接口选择**：程序优先使用东方财富接口，如果失败则尝试其他接口，但不使用新浪接口的复权因子数据
4. **并行处理**：程序使用多线程并行处理，提高效率

## 数据库表结构

### 复权因子表

```sql
CREATE TABLE IF NOT EXISTS public."复权因子表" (
    "股票代码" varchar(10) NOT NULL,
    "日期" date NOT NULL,
    "前复权因子" double precision,
    "后复权因子" double precision,
    "更新时间" timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "复权因子表_pkey" PRIMARY KEY ("股票代码", "日期")
)
```

## 依赖项

- Python 3.6+
- pandas
- numpy
- akshare
- psycopg2
- tqdm

## 故障排除

如果遇到问题，请检查：

1. 数据库连接是否正常
2. AKShare接口是否可用
3. 日志文件中的错误信息

## 日志

程序运行日志保存在项目的logs目录下，文件名为adjustment_factor.log。