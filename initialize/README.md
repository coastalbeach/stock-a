# SQL文件批量执行工具

## 简介

这是一个用于批量执行SQL文件的Python脚本工具，专为PostgreSQL数据库设计。该工具可以按照文件名顺序执行目录中的所有SQL文件，确保表之间的依赖关系正确处理。

## 功能特点

- 自动按文件名顺序执行SQL文件
- 支持多种文件编码（UTF-8, GBK, GB2312, GB18030, Latin1）
- 提供命令行参数配置数据库连接信息
- 自动重试失败的SQL执行
- 详细的执行日志记录
- 显示执行进度和时间统计

## 目录结构

```
./
├── 01_basic_tables.sql       # 基础表：股票基本信息、概念板块、行业板块
├── 02_financial_tables.sql   # 财务相关表：利润表、现金流量表、资产负债表、财务指标
├── 03_lhb_tables.sql         # 龙虎榜相关表：龙虎榜详情、个股上榜统计
├── 04_stock_history_tables.sql # 股票历史行情表：不复权、后复权
├── 05_industry_index_tables.sql # 行业和指数历史行情表
├── 06_technical_indicator_tables.sql # 技术指标相关表
├── execute_sql_files.py      # 批量执行SQL文件的Python脚本
└── README.md                 # 说明文档
```

## 使用前准备

1. 确保已安装Python 3.6+
2. 安装必要的Python库：
   ```
   pip install psycopg2
   ```
3. 确保PostgreSQL数据库已创建并可访问

## 使用方法

### 基本用法

```bash
python execute_sql_files.py
```

这将使用默认参数执行当前目录下的所有SQL文件。

### 高级用法

```bash
python execute_sql_files.py --dbname mydb --user myuser --password mypass --host localhost --port 5432 --retry 5
```

### 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--dbname` | 数据库名称 | stocka |
| `--user` | 用户名 | postgres |
| `--password` | 密码 | 123456 |
| `--host` | 主机地址 | localhost |
| `--port` | 端口号 | 5432 |
| `--retry` | 最大重试次数 | 3 |
| `--dir` | SQL文件目录 | 脚本所在目录 |
| `--help` | 显示帮助信息 | - |

## 执行流程

1. 脚本会按照文件名顺序执行SQL文件，确保依赖关系正确
2. 对于每个SQL文件，脚本会尝试多种编码方式读取
3. 如果执行失败，会自动重试（默认最多3次）
4. 执行过程中会生成详细的日志文件

## 注意事项

1. SQL文件应按照依赖关系命名，确保前缀数字正确排序
2. 如果SQL文件包含中文，建议使用UTF-8编码保存
3. 脚本会自动处理编码问题，但如果遇到无法识别的编码，请手动转换文件编码
4. 执行大型SQL文件可能需要较长时间，请耐心等待

## 故障排除

### 编码问题

如果遇到编码错误，脚本会尝试多种编码方式读取文件。如果仍然失败，可以尝试手动将文件转换为UTF-8编码：

1. 使用记事本打开文件
2. 选择「另存为」
3. 在「编码」下拉菜单中选择「UTF-8」
4. 保存文件并重新执行脚本

### 数据库连接问题

如果无法连接到数据库，请检查：

1. 数据库服务是否正在运行
2. 连接参数（用户名、密码、主机、端口）是否正确
3. 数据库是否已创建
4. 用户是否有足够的权限

## 日志文件

脚本执行过程中会在当前目录生成日志文件，格式为：
```
sql_execution_log_YYYYMMDD_HHMMSS.txt
```

日志文件包含以下信息：
- 执行时间
- 数据库连接信息
- SQL文件列表
- 每个文件的执行结果和耗时
- 总执行结果和总耗时
- 错误信息（如有）