# PostgreSQL 触发器测试指南

本文档提供了安全测试 PostgreSQL 触发器和函数的详细指南，避免在生产环境中直接测试可能导致的数据损坏风险。

## 测试方案概述

我们采用的测试方案基于以下核心原则：

1. **隔离环境**：在临时测试数据库中进行所有测试，不影响生产数据库
2. **自动化**：通过配置文件定义测试用例，实现测试的自动化执行
3. **可重复**：测试过程可以随时重复，结果可预期且一致
4. **全面验证**：验证触发器是否正确触发以及相关函数是否被调用
5. **报告生成**：生成详细的测试报告，便于分析和记录

## 测试工具说明

本目录提供了两个测试脚本：

1. **test_triggers.py**：基础测试脚本，提供简单的触发器测试功能
2. **test_triggers_enhanced.py**：增强版测试脚本，基于配置文件执行测试，提供更详细的测试报告

## 测试配置文件

`test_config.yaml` 文件定义了测试用例和测试环境配置：

```yaml
# 测试用例配置
test_cases:
  - name: "测试用例名称"
    description: "测试用例描述"
    setup:
      - type: "insert"  # 设置测试数据
        table: "表名"
        data:
          "列名1": "值1"
          "列名2": "值2"
    verification:
      - type: "check_function_called"  # 验证函数是否被调用
        function_name: "函数名"

# 测试数据库配置
database:
  keep_after_test: false  # 测试后是否保留测试数据库
  name_prefix: "test_triggers"  # 测试数据库名称前缀
```

## 使用方法

### 基础测试脚本

```bash
# 运行所有测试
python trigger/test_triggers.py --test-all

# 运行测试并保留测试数据库（用于调试）
python trigger/test_triggers.py --test-all --keep-db
```

### 增强版测试脚本

```bash
# 运行所有测试
python trigger/test_triggers_enhanced.py --test-all

# 运行测试并保留测试数据库（用于调试）
python trigger/test_triggers_enhanced.py --test-all --keep-db

# 指定测试报告输出路径
python trigger/test_triggers_enhanced.py --test-all --report ./logs/my_test_report.json
```

## 测试报告说明

增强版测试脚本会生成JSON格式的测试报告，包含以下信息：

- 测试摘要：总测试数、通过数、失败数、成功率
- 详细测试结果：每个测试用例的执行情况、验证结果
- 时间戳：测试执行时间

## 安全注意事项

1. **测试数据库命名**：测试数据库名称包含随机后缀，避免冲突
2. **自动清理**：默认情况下，测试完成后会自动删除测试数据库
3. **事务控制**：所有测试操作都在事务中执行，确保数据一致性
4. **错误处理**：脚本包含完善的错误处理机制，避免意外情况

## 测试最佳实践

1. **先在开发环境测试**：始终在开发环境中先运行测试，确认无误后再考虑在生产环境测试
2. **增量测试**：先测试单个触发器，确认无误后再测试多个触发器的组合效果
3. **保留测试数据库**：调试复杂问题时，使用 `--keep-db` 参数保留测试数据库，便于手动检查
4. **定制测试用例**：根据实际需求修改 `test_config.yaml`，添加更多测试用例
5. **定期回归测试**：在每次修改触发器或相关函数后，运行完整的测试套件

## 故障排除

### 常见问题

1. **无法创建测试数据库**
   - 检查数据库用户权限是否足够
   - 确认PostgreSQL服务是否正常运行

2. **触发器未被触发**
   - 检查触发器定义是否正确
   - 确认测试数据是否符合触发条件
   - 增加延迟时间，给触发器更多执行时间

3. **验证失败**
   - 检查验证方法是否适合当前触发器
   - 查看PostgreSQL日志获取更多信息

### 调试技巧

1. 使用 `--keep-db` 参数保留测试数据库，然后手动连接检查
2. 增加日志级别，获取更详细的执行信息
3. 在触发器函数中添加更多的 `RAISE NOTICE` 语句，帮助跟踪执行流程

## 结论

通过使用这些测试工具，您可以安全地测试PostgreSQL触发器和函数，而不必担心损坏生产数据。测试过程完全自动化，可以轻松集成到开发工作流程中，确保数据库功能的可靠性和稳定性。